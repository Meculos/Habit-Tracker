{% extends "habit_tracker/layout.html" %}
{% load static %}

{% block title %}
    Chat Area - Habit Tracker
{% endblock %}

{% block nav %}
    <div style="background-color: #221d23;" class="d-none d-md-block">
        <header class="d-flex justify-content-center align-items-center" style="height: 50px;">
            <h5 style="color: white;">{{ friend.username }}</h5>
        </header>
    </div>
    <nav id="smhomepagenav" class="navbar bg-body-tertiary px-3 mt-4 d-md-none">               
        <a class="navbar-brand" style="color: white;" href="#">Habit Tracker</a>
        <ul class="nav nav-pills">
            <li class="nav-item dropdown d-md-none">
                <a class="nav-link dropdown-toggle" style="color: white;" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Menu</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'index' %}#navitem1">Home</a></li>
                    <li><a class="dropdown-item" href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li><a class="dropdown-item" href="{% url 'profile' user.id %}">Profile</a></li>
                    <li><a class="dropdown-item" href="{% url 'friends_list' %}">Friends List</a></li>
                    <li><a class="dropdown-item" href="{% url 'friends_posts' %}">Friends Posts</a></li>
                    <li><a class="dropdown-item" href="{% url 'community' %}">Community</a></li>
                    <li><a class="dropdown-item" href="{% url 'friends_corner' %}">Social Corner</a></li>
                    <li><a class="dropdown-item" href="{% url 'make_post' %}">Create Post</a></li>
                    {% if not user.is_authenticated %}
                        <li><a class="dropdown-item" href="{% url 'login' %}">Login</a></li>
                    {% else %}
                        <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
                    {% endif %}
                </ul>
            </li>
        </ul>
    </nav>
{% endblock %}

{% block main %}
    <div class="d-flex">
        <nav class="col-md-3 col-lg-2 d-none d-md-block sidebar" id="friendnav">
            <div class="position-sticky d-flex justify-content-center">
                <ul class="nav flex-column mt-4">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'index' %}">
                            <h5><i class="fas fa-home"></i> Home</h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        {% if user.is_authenticated %}
                            <a class="nav-link" href="{% url 'profile' user.id %}">
                                <h5><i class="fas fa-user"></i> Profile</h5>
                            </a>
                        {% else %}
                            <a class="nav-link" href="{% url 'login' %}">
                                <h5><i class="fas fa-sign-in-alt"></i> Login</h5>
                            </a>
                        {% endif %}
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'log_page' %}">
                            <h5><i class="fas fa-book"></i> Logbook</h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard' %}">
                            <h5><i class="fas fa-gauge"></i> Dashboard</h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'friends_list' %}">
                            <h5><i class="fas fa-heart"></i> Friends List</h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'friends_posts' %}">
                            <h5><i class="fas fa-bullhorn"></i> Friends Posts</h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'community' %}">
                            <h5><i class="fas fa-users"></i> Community</h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'friends_corner' %}">
                            <h5><i class="fas fa-users"></i> Social Corner</h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'make_post' %}">
                            <h5><i class="fas fa-pen"></i> Create Post</h5>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- <nav class="col-sm-1 d-md-none sidebar" id="smallfriendnav">
            <div class="position-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'index' %}">
                            <h5><i class="fas fa-home" title="Homepage"></i></h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        {% if user.is_authenticated %}
                            <a class="nav-link" href="{% url 'profile' user.id %}">
                                <h5><i class="fas fa-user" title="Profile"></i></h5>
                            </a>
                        {% else %}
                            <a class="nav-link" href="{% url 'login' %}">
                                <h5><i class="fas fa-sign-in-alt" title="Login"></i></h5>
                            </a>
                        {% endif %}
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'log_page' %}">
                            <h5><i class="fas fa-book" title="Logbook"></i></h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard' %}">
                            <h5><i class="fas fa-gauge" title="Dashboard"></i></h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'friends_list' %}">
                            <h5><i class="fas fa-heart" title="Friends List"></i></h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'friends_posts' %}">
                            <h5><i class="fas fa-bullhorn" title="Friends Posts"></i></h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'community' %}">
                            <h5><i class="fas fa-users" title="Community"></i></h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'friends_corner' %}">
                            <h5><i class="fas fa-users" title="Social Corner"></i></h5>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'make_post' %}">
                            <h5><i class="fas fa-pen" title="Create Post"></i></h5>
                        </a>
                    </li>
                </ul>
            </div>
        </nav> -->
        <div id="chat-container" class="col-lg-8 col-md-6 col-sm-12" style="background-color: rgb(231, 224, 224);">
            <div id="chat-messages" style="max-height: 70vh; overflow-y: auto; padding: 10px; background-color: #bec5ad;">
                {% for message in messages %}
                    {% if message.message_class == "incoming" %}
                        <div class="message-row {{ message.message_class }} d-flex mb-3 align-items-end">
                            {% if message.message_class == "incoming" %}
                                <img src="{{ friend.profile_picture.url }}" 
                                    alt="Friend's Profile" 
                                    class="profile-picture rounded-circle me-3"
                                    style="width: 40px; height: 40px; object-fit: cover;">
                            {% endif %}
                            <div class="message-content p-3 rounded" style="background-color: #f1f1f1;">
                                <p class="mb-1" style="white-space: pre-wrap;">{{ message.content }}</p>
                                <small class="text-muted">{{ message.timestamp }}</small>
                            </div>
                        </div>
                    {% else %}
                        <div class="message-row {{ message.message_class }} d-flex mb-3 align-items-end">
                            <div class="message-content p-3 rounded" style="background-color: gray;">
                                <p class="mb-1" style="white-space: pre-wrap;">{{ message.content }}</p>
                                <small class="text-muted">{{ message.timestamp }}</small>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="chat-input-container d-flex mt-3" style="gap: 10px;">
                <input type="hidden" id="user-id" value="{{ user.id }}">
                {% csrf_token %}
                <textarea id="chat-input" class="form-control" placeholder="Type your message..." style="resize: none;"></textarea>
                <button id="send-button" data-friend-id="{{ friend.id }}" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="{% static 'habit_tracker/chat_page.js' %}"></script>
{% endblock %}